# MTS Design Weekend - Карты предсказаний

Интерактивное мини-приложение для Telegram, которое позволяет получать уникальные метафорические предсказания на основе дизайнерских карт.

## Функциональность

- Интеграция с Telegram как мини-приложение (Telegram WebApp)
- Загрузка фотографий карт с предпросмотром
- Распознавание QR-кодов на картах для точной идентификации
- Генерация уникальных метафорических предсказаний
- Возможность поделиться предсказанием
- Совместимость с мобильными устройствами
- Опциональная интеграция с OpenAI API для генерации уникальных предсказаний

## Технологии

- HTML5, CSS3, JavaScript (ванильный, без фреймворков)
- Telegram Bot API и WebApp API
- jsQR для распознавания QR-кодов
- Web Share API для функции "Поделиться"


В последнем обновлении приложения MTS Design Weekend были исправлены следующие проблемы:

1. **Улучшена обработка ошибок WebGL**:
   - Добавлена проверка поддержки WebGL в браузере пользователя
   - Добавлено информативное сообщение, если WebGL не поддерживается
   - Приложение теперь корректно работает даже при отсутствии поддержки WebGL (без 3D эффектов)

2. **Улучшена валидация QR-кодов**:
   - Исправлена ошибка, когда при нераспознанном QR-коде использовалась случайная карта
   - Добавлено сообщение пользователю с просьбой сделать более четкое фото
   - Проверяется соответствие QR-кода существующим картам в системе

3. **Добавлена фильтрация нецензурной лексики**:
   - Реализована проверка вопросов на наличие нецензурных слов
   - Добавлена защита от обхода фильтров с помощью символов-заменителей
   - Проверка минимальной длины вопроса для более осмысленных запросов

4. **Улучшена обработка файлов**:
   - Добавлена проверка типа загружаемых файлов (только изображения)
   - Добавлено ограничение на размер файла (не более 10 МБ)
   - Информативные сообщения при ошибках загрузки файлов

5. **Улучшена обработка ошибок**:
   - Добавлены более детальные сообщения об ошибках
   - Добавлена индикация предупреждений с желтым цветом
   - Исправлены ошибки в CSS, связанные с отображением элементов

## Обновления (19.05.2025)

### Исправление сохранения настроек API и серверных функций

В этом обновлении исправлены проблемы с сохранением настроек API и реализован более надежный механизм централизованного управления конфигурацией:

1. **Улучшена обработка CORS-заголовков**:
   - Добавлена поддержка CORS в PHP-скрипт сохранения конфигурации
   - Обработка предварительных OPTIONS-запросов для совместимости с современными браузерами
   - Корректная обработка HTTP-статусов и соответствующих ошибок

2. **Улучшена обработка ошибок при сохранении**:
   - Каскадная система сохранения с несколькими резервными механизмами
   - Более информативные сообщения об ошибках с конкретными причинами
   - Автоматическое сохранение в localStorage при ошибках серверного сохранения

3. **Обновлен механизм запуска локального сервера**:
   - Добавлены скрипты для запуска PHP-сервера на Windows и Mac/Linux
   - Автоматическая проверка наличия PHP и подробные инструкции по установке
   - Улучшенная диагностика проблем с доступом к серверу

4. **Улучшена работа в офлайн-режиме**:
   - Настройки API теперь всегда сохраняются локально, даже при ошибках серверного сохранения
   - Добавлен механизм синхронизации локальных и серверных настроек
   - Приоритизация глобальной конфигурации с возможностью отката к локальной

5. **Добавлены проверки безопасности**:
   - Валидация данных перед сохранением на сервере
   - Защита от ошибок форматирования и некорректных значений
   - Сохранение резервной копии конфигурации перед изменениями

Для использования этих улучшений рекомендуется запускать локальный PHP-сервер с помощью скриптов `start-server.bat` (Windows) или `go.sh` (MacOS/Linux). Подробная инструкция доступна в разделе "Запуск локального сервера".

## Обновления интерфейса (07.05.2025)

В интерфейс приложения "Карты предсказаний" были внесены следующие улучшения:

### Экран вопроса
- Удален старый заголовок "Выберите или создайте вопрос"
- Добавлен новый заголовок "Выберите вопрос"
- Изменено расположение элементов: превью фото теперь между заголовком и блоком вопросов
- Изменен текст поля ввода на "Ваш вопрос"
- Изменен порядок кнопок навигации: сначала "Получить предсказание", затем "Назад"
- Добавлена логика активации кнопки "Получить предсказание" только после выбора/ввода вопроса
- Улучшена визуальная обратная связь при выборе вопроса

### Экран результатов
- Исправлены проблемы с отображением (скрытием) экрана результатов
- Добавлены принудительные стили для гарантированного отображения контента
- Отключены анимации, которые могли вызывать проблемы
- Улучшены стили для текста предсказания и изображения карты
- Исправлены размеры и стилизация кнопок действий

### Мобильная версия
- Исправлено позиционирование кнопок на первом экране (больше не прибиваются к низу на узких экранах)
- Улучшена адаптивность элементов на всех экранах
- Добавлены специальные стили для очень узких экранов (до 360px)
- Увеличены сенсорные области для лучшего взаимодействия на мобильных устройствах

### Исправления JavaScript
- Удалены невалидные селекторы, вызывающие ошибки в консоли
- Добавлена более эффективная функция для удаления текстовых узлов со строкой "download.png"
- Улучшена логика переключения между экранами
- Добавлены проверки на наличие элементов перед взаимодействием с ними

### Дополнительные улучшения
- Добавлены дополнительные проверки видимости элементов
- Улучшены стили кнопок с фиксированной высотой 
- Оптимизированы стили для лучшей совместимости с разными браузерами
- Добавлены дополнительные медиа-запросы для различных размеров экранов

## Работа с репозиторием

### Ветки
- `main` - основная ветка для разработки
- `master` - историческая ветка 
- `gh-pages` - автоматически обновляемая ветка для GitHub Pages

### Деплой
Для деплоя проекта используется GitHub Actions. Настроен автоматический деплой при коммите в ветки `main`, `master` и `gh-pages`.

```bash
# Для ручного деплоя можно использовать:
.\deploy.ps1  # Для Windows
./go.sh       # Для MacOS/Linux
```

## Запуск локального сервера

Для корректной работы сохранения настроек API и других серверных функций необходимо запустить локальный PHP-сервер.

### Windows

Для запуска локального PHP-сервера в Windows:

1. Убедитесь, что PHP установлен в системе. Если нет, скачайте и установите его с [официального сайта](https://windows.php.net/download/).
2. Запустите файл `start-server.bat` из корневой директории проекта.
3. В браузере откройте http://localhost:8000

### MacOS/Linux

Для запуска локального PHP-сервера в MacOS/Linux:

1. Убедитесь, что PHP установлен в системе. Если нет, установите его через пакетный менеджер:
   ```bash
   # Для Ubuntu/Debian
   sudo apt install php

   # Для MacOS
   brew install php
   ```
2. Запустите PHP-сервер из корневой директории проекта:
   ```bash
   php -S localhost:8000
   ```
3. В браузере откройте http://localhost:8000

### Решение проблем с сохранением настроек API

Если возникают проблемы с сохранением настроек API:

1. Убедитесь, что локальный PHP-сервер запущен.
2. Проверьте наличие ошибок в консоли браузера (F12 или Ctrl+Shift+I).
3. Проверьте права доступа к файлу `config.json` (он должен быть доступен для записи).
4. В случае проблем с PHP-сервером, настройки будут сохраняться только локально в localStorage браузера.

Чтобы проверить работу сохранения настроек:
1. Откройте http://localhost:8000/api-settings.html
2. Введите настройки API и нажмите кнопку "Сохранить настройки"
3. При успешном сохранении появится сообщение "Настройки успешно сохранены"

## Размещение на Cloudflare Pages

Для размещения проекта на Cloudflare Pages вместо GitHub Pages выполните следующие шаги:

1. Создайте аккаунт на [Cloudflare](https://dash.cloudflare.com/sign-up) если у вас его еще нет
2. В панели управления Cloudflare выберите **Pages** в левом меню
3. Нажмите кнопку **Create a project**
4. Выберите опцию **Connect to Git**
5. Авторизуйтесь в GitHub и предоставьте доступ к вашему репозиторию
6. Выберите репозиторий с проектом

### Настройка параметров сборки

- **Project name**: mts-design-cards (или другое имя)
- **Production branch**: main (или master)
- **Framework preset**: None/Static site
- **Build command**: оставьте пустым
- **Build output directory**: / (корень проекта)

### Настройка конфигурации на Cloudflare Pages

Так как Cloudflare Pages не поддерживает PHP, в проект добавлен механизм настройки через JavaScript:

1. Откройте раздел **API-настройки** в админ-панели
2. Настройте все параметры API
3. Нажмите кнопку **Экспорт настроек** для сохранения конфигурации в файл
4. При необходимости вы можете импортировать настройки, нажав кнопку **Импорт настроек**

Все настройки будут храниться в localStorage браузера, поэтому они будут доступны только на конкретном устройстве и браузере.

### Преимущества Cloudflare Pages

- Автоматическое развертывание при обновлении репозитория
- Глобальная CDN сеть с кэшированием статических файлов
- HTTPS из коробки
- Неограниченное количество сайтов на бесплатном плане
- Web Analytics для отслеживания посещений

## Быстрый деплой на Cloudflare Pages