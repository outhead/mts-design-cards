/**
 * ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð´Ð° Ð±Ð¾Ñ‚Ð° Telegram Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Ð¼Ð¸Ð½Ð¸-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼
 * 
 * Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ:
 * 1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹: npm install telegraf dotenv
 * 2. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸ (ÑÐ¼. .env.example)
 * 3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ: node bot-example.js
 */

const { Telegraf } = require('telegraf');
require('dotenv').config();

// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';

// URL Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
const WEB_APP_URL = process.env.WEB_APP_URL || 'https://yourusername.github.io/mts-design-cards/';

// Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ°Ñ€Ñ‚Ð°Ñ…
const cards = {
  'design001': 'ÐœÐµÑ‚Ð°Ñ„Ð¾Ñ€Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸',
  'design002': 'ÐœÐ¾ÑÑ‚ Ð¼ÐµÐ¶Ð´Ñƒ Ð¼Ð¸Ñ€Ð°Ð¼Ð¸',
  'design003': 'Ð¡Ð°Ð´Ð¾Ð²Ð½Ð¸Ðº Ð¸Ð´ÐµÐ¹',
  'design004': 'ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚Ð¾Ñ€ ÑÐ¼Ð¾Ñ†Ð¸Ð¹',
  'design005': 'ÐÐ»Ñ…Ð¸Ð¼Ð¸Ðº Ñ„Ð¾Ñ€Ð¼',
  'design006': 'ÐœÐ°ÑÑ‚ÐµÑ€ Ñ€Ð°Ð²Ð½Ð¾Ð²ÐµÑÐ¸Ñ',
  'design007': 'ÐŸÑƒÑ‚ÐµÑˆÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¸Ðº Ð¿Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°Ð¼',
  'design008': 'Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ð°ÑÐ»ÐµÐ´Ð¸Ñ',
  'design009': 'Ð”Ð¸Ñ€Ð¸Ð¶Ñ‘Ñ€ Ð¾Ñ€ÐºÐµÑÑ‚Ñ€Ð° Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹',
  'design010': 'Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½ÐµÐ¸Ð·Ð²ÐµÐ´Ð°Ð½Ð½Ð¾Ð³Ð¾',
  'design011': 'ÐÐ°Ð²Ð¸Ð³Ð°Ñ‚Ð¾Ñ€ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÐµÐ¹',
  'design012': 'Ð¡Ð¾Ð±Ð¸Ñ€Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¼Ñ‹ÑÐ»Ð¾Ð²',
  'design013': 'ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ ÑÐ·Ñ‹ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ',
  'design014': 'ÐœÐ°ÑÐº Ð² Ñ‚ÑƒÐ¼Ð°Ð½Ðµ',
  'design015': 'ÐšÑƒÐ·Ð½ÐµÑ† Ð²Ð¿ÐµÑ‡Ð°Ñ‚Ð»ÐµÐ½Ð¸Ð¹',
  'design016': 'Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸',
  'design017': 'Ð”Ð¸Ñ‚Ñ Ð»ÑŽÐ±Ð¾Ð¿Ñ‹Ñ‚ÑÑ‚Ð²Ð°',
  'design018': 'ÐœÐ°ÑÑ‚ÐµÑ€ Ð¿Ð°ÑƒÐ·',
  'design019': 'Ð¢ÐºÐ°Ñ‡ Ð¿Ð¾Ð²ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ð¹',
  'design020': 'ÐšÐ°Ñ€Ñ‚Ð¾Ð³Ñ€Ð°Ñ„ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÐµÐ¹',
  'design021': 'Ð”Ð¸Ð¿Ð»Ð¾Ð¼Ð°Ñ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²',
  'design022': 'Ð¡ÐºÑƒÐ»ÑŒÐ¿Ñ‚Ð¾Ñ€ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ‚Ñ‹',
  'design023': 'Ð¥Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹',
  'design024': 'Ð¨Ð°Ñ…Ð¼Ð°Ñ‚Ð¸ÑÑ‚ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼',
  'design025': 'Ð¡Ð°Ð´Ð¾Ð²Ð½Ð¸Ðº ÑÐºÐ¾ÑÐ¸ÑÑ‚ÐµÐ¼',
  'design026': 'ÐŸÑ€Ð¾Ð²Ð¾Ð´Ð½Ð¸Ðº Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½'
};

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(BOT_TOKEN);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start((ctx) => {
  ctx.reply('ðŸ‘‹ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾Ñ‚ ÐšÐ°Ñ€Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹ MTS Design Weekend!', {
    reply_markup: {
      keyboard: [
        [{
          text: 'ðŸ”® ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹',
          web_app: { url: WEB_APP_URL }
        }]
      ],
      resize_keyboard: true
    }
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.help((ctx) => {
  ctx.reply(`
ðŸ“± ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°:

1ï¸âƒ£ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹" Ð½Ð¸Ð¶Ðµ
2ï¸âƒ£ Ð—Ð°Ð³Ð°Ð´Ð°Ð¹Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ñ„Ð¾Ñ€Ð¼Ñƒ
3ï¸âƒ£ Ð’Ñ‹Ñ‚ÑÐ½Ð¸Ñ‚Ðµ ÐºÐ°Ñ€Ñ‚Ñƒ Ð¸Ð· ÐºÐ¾Ð»Ð¾Ð´Ñ‹ Ð¸ ÑÑ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÑ‘
4ï¸âƒ£ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸
5ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐµ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
6ï¸âƒ£ ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ð¾Ðµ

ðŸ’¡ ÐŸÐ¾Ð´ÑÐºÐ°Ð·ÐºÐ°: ÐšÐ°Ð¶Ð´Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð° Ð¸Ð¼ÐµÐµÑ‚ QR-ÐºÐ¾Ð´ Ð´Ð»Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ QR-ÐºÐ¾Ð´ Ð²Ð¸Ð´ÐµÐ½ Ð½Ð° Ñ„Ð¾Ñ‚Ð¾.

Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ /start.
  `);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /cards Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ°Ñ€Ñ‚
bot.command('cards', (ctx) => {
  let message = 'ðŸ“š Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÐºÐ°Ñ€Ñ‚ Ð¸ Ð¸Ñ… Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹:\n\n';
  
  for (const [id, title] of Object.entries(cards)) {
    message += `â€¢ ${id}: ${title}\n`;
  }
  
  ctx.reply(message);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ñ… Ð¾Ñ‚ WebApp
bot.on('web_app_data', (ctx) => {
  const data = ctx.webAppData.data;
  try {
    const parsedData = JSON.parse(data);
    
    // Ð•ÑÐ»Ð¸ Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    if (parsedData.prediction) {
      let message = `ðŸ”® *Ð’Ð°ÑˆÐµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ*\n\n`;
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ°Ñ€Ñ‚Ðµ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ
      if (parsedData.cardKey && cards[parsedData.cardKey]) {
        message += `ÐšÐ°Ñ€Ñ‚Ð°: *${cards[parsedData.cardKey]}*\n\n`;
      }
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      if (parsedData.question) {
        message += `Ð’Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ: _${parsedData.question}_\n\n`;
      }
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ°Ð¼Ð¾ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
      message += parsedData.prediction;
      
      ctx.replyWithMarkdown(message);
    } else {
      ctx.reply('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð½Ð¾ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾.');
    }
  } catch (e) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚ WebApp:', e);
    ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ….');
  }
});

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
bot.launch()
  .then(() => console.log('Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ðŸš€'))
  .catch((err) => console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð±Ð¾Ñ‚Ð°:', err));

// Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM')); 